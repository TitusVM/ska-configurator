# SKA Configurator - Work Log

## Status: Phase 10 — Multi-SKA Folder Mode

### Decisions (from user, 2026-02-13)
- Java 21, Swing GUI
- User-to-group: CSV import + manual GUI override
- Load existing SKA XML files + create new
- skamodify protection levels: configurable per operation
- Module name & key labels: free-text user input
- EC params: predefined curve list + raw PEM paste
- Cert change: on CSV import, diff vs loaded SKA, prompt to update stale certs

### 2026-02-13 - Initial Analysis
- Read README.md, example/ska.xml, exports/export.csv, pom.xml, App.java
- XML structure: skaconfig > {organization, skaplus, skamodify, keys>proto, users}
- Operations: use, modify, block, unblock — each with boundaries>groups>members
- CSV: 32+ cols (cn, cert, Email, Organisation, userId, role cols like Org Owner/SecOff/Op)

---
## IMPLEMENTATION PLAN (step by step)

### Phase 1: Project setup
- [x] 1.1 Update pom.xml (Java 21, OpenCSV 5.9, FlatLaf 3.4, JUnit 4.13.2, maven-shade for fat JAR)
- [x] 1.2 Clean up App.java (FlatLaf L&F, basic JFrame launch)
- [x] 1.3 Build verified (mvn clean package), JAR runs OK

### Phase 2: Data model
- [x] 2.1 SkaConfig (root), SkaSection (org/skaplus/skamodify), KeysProto
- [x] 2.2 Operations, Operation, Boundary, Group
- [x] 2.3 User, EcParameters
- [x] 2.4 Build verified — all 9 model classes compile

### Phase 3: CSV import
- [x] 3.1 Added role fields (orgOwnerOf/orgSecOffOf/orgOpOf) to User model
- [x] 3.2 CsvImporter: OpenCSV RFC4180 parser, header-based column mapping
- [x] 3.3 Handles: multiline PEM certs, &nbsp; cleanup, cert in wrong column, || multi-values
- [x] 3.4 Deduplication by CN (merges data, keeps latest cert, unions roles)
- [x] 3.5 CsvImporterTest: 5 tests pass (real CSV import, cert cleaning, multi-value parsing)

### Phase 4: XML read/write
- [x] 4.1 SkaXmlReader: DOM parser, reads all sections/operations/boundaries/groups/users
- [x] 4.2 SkaXmlWriter: DOM builder, indented output, CDATA for certs, curveName attr
- [x] 4.3 Security: external entities disabled in reader
- [x] 4.4 SkaXmlReaderWriterTest: 2 tests (full read + round-trip), all 8 tests pass

### Phase 5: Swing GUI — main frame & navigation
- [x] 5.1 MainFrame: menu bar (New/Open/Save/SaveAs/Import CSV/Exit), keyboard shortcuts
- [x] 5.2 GlobalConfigPanel: moduleName, version, per-section key labels + validity + blockedOnInit
- [x] 5.3 File ops: open XML, save XML, CSV import with cert-change detection + new-user prompt
- [x] 5.4 Status bar, bidirectional model↔UI sync (loadFrom/saveTo)
- [x] 5.5 App.java wired to MainFrame, build + smoke test OK

### Phase 6: Swing GUI — section panels
- [x] 6.1 EcParametersPanel: curve combo (predefined + free text) + PEM text area
- [x] 6.2 OperationPanel: delay/timeLimit spinners, boundary list, group list, group detail
       — group detail: name, quorum, members/keys radio, add/remove members, Apply button
       — deep-copy boundaries for safe editing, confirmation on destructive ops
- [x] 6.3 SectionPanel (org/skaplus/skamodify): EC params + 4 operation sub-tabs
- [x] 6.4 KeysProtoPanel: same layout without key metadata
- [x] 6.5 MainFrame wired: 5 tabs (Global Config, Organization, SKA Plus, SKA Modify, Keys Proto)
- [x] 6.6 Build + smoke test OK

### Phase 7: Swing GUI — user management
- [x] 7.1 UsersPanel: JTable (CN, Name, Email, Organisation, UserID, Cert ✓/—), add/edit/remove/view cert buttons
- [x] 7.2 UserEditDialog: modal form for add/edit user (CN required, name, email, org, userId, cert PEM)
- [x] 7.3 UserPickerDialog: multi-select modal to pick users by CN for group membership
- [x] 7.4 OperationPanel: "Pick from Users…" button, user supplier pattern, dedup on add
- [x] 7.5 SectionPanel/KeysProtoPanel: setUserListSupplier pass-through
- [x] 7.6 MainFrame: Users tab wired, user supplier connected to all section panels
- [x] 7.7 Build + all 8 tests pass

### Phase 8: Validation & polish
- [x] 8.1 Dirty flag: tracks unsaved changes, title bar shows `*` when dirty
- [x] 8.2 Unsaved-changes guard: New/Open prompt to discard; Exit prompts save/discard/cancel
- [x] 8.3 Window close intercept (DO_NOTHING_ON_CLOSE + WindowAdapter → doExit)
- [x] 8.4 Save validation warnings: missing module name, missing certs, empty groups, bad date formats
- [x] 8.5 GlobalConfigPanel: date format tooltips (YYYY-MM-DD), validateFields() method
- [x] 8.6 UserEditDialog: PEM format warning (BEGIN/END markers), duplicate CN check, Escape to close
- [x] 8.7 UserPickerDialog: Escape to close, null-safe return (empty list instead of null)
- [x] 8.8 UsersPanel: status bar feedback on add/edit/remove, dirty callback, auto-select new row
- [x] 8.9 Build + all 8 tests pass

### Phase 9: Build & packaging
- [x] 9.1 Fat JAR: maven-shade-plugin produces ska-configurator-1.0-SNAPSHOT.jar (3.5 MB, all deps bundled)
- [x] 9.2 Smoke test: JAR launches GUI correctly (`java -jar target/ska-configurator-1.0-SNAPSHOT.jar`)
- [x] 9.3 End-to-end integration test: XML read → CSV import → modify → save → re-read (EndToEndTest.java)
- [x] 9.4 All 9 tests pass (1 AppTest + 5 CsvImporter + 2 XmlReaderWriter + 1 EndToEnd)
- [x] 9.5 .gitignore updated (dependency-reduced-pom.xml, .idea/, *.iml)
- [x] 9.6 Final clean build: BUILD SUCCESS

### Post-Phase improvements (2026-02-13)
- [x] README.md rewritten with full documentation
- [x] Git history cleanup: removed example/ska_test.xml containing personal data (filter-branch + gc)
- [x] Keys child name: dynamic <keys> child element name (was hardcoded "proto")
      — KeysProto.childName field, reader auto-detects tag, writer uses stored name
      — GlobalConfigPanel: "Keys child name" field, MainFrame: dynamic tab label "Keys (xxx)"
      — Default empty, read from loaded SKA or filled by user
- [x] XML header: added xmlns:xsi + xsi:noNamespaceSchemaLocation support
      — SkaConfig.xsiNoNamespaceSchemaLocation field, reader reads it (namespace-aware), writer outputs it
      — GlobalConfigPanel: "XSD schema" field
      — Removed standalone="yes" from XML output (doc.setXmlStandalone(true))
- [x] Prod/Integration toggle: JRadioButton toolbar for environment selection
      — User model: added userIdIntegration field
      — CsvImporter: reads "userID Integration" column
      — SkaXmlWriter: writes correct userId based on environment flag
      — UsersPanel: dynamic column header "UserID (Prod)" / "UserID (Int)"
      — UserEditDialog: shows both "User ID (Prod)" and "User ID (Integration)" fields
- [x] Version bump prompt: on save, prompt to increase version if unchanged since load
      — loadedVersion tracked on open, not updated on save (prevents re-prompt after bump)
- [x] Round-trip test: assertion verifying no standalone attribute in XML output
- [x] All 9 tests pass after all improvements

---
### Phase 10: Multi-SKA folder mode (2026-02-16)

#### Design decisions
- Open a folder of *.xml SKA files, edit one at a time via a selector
- Single master user pool (union of all users across all SKAs, keyed by CN)
- Shared User instances: cert/email/userId edits propagate to all SKAs referencing that user
- Each SKA keeps its own user subset (which users are included)
- Single-file open still works (workspace of 1)
- Prod/Integration toggle is global (applies to all SKAs)
- "Pick from Users" in operation panels picks from per-SKA user list (not master pool)
- Master pool merge: on conflict (same CN, different cert), keep last-loaded; CSV import overrides all
- Removing from master pool warns about affected SKAs; removing from per-SKA only un-links

#### Implementation plan
- [x] 10.1 Model layer: SkaWorkspace class (List<SkaConfigEntry>, master user pool)
      — SkaConfigEntry: SkaConfig + File sourceFile + int loadedVersion + boolean dirty
- [x] 10.2 File operations: "Open Folder…" menu item, load all *.xml, build master pool
      — Merge users by CN into shared instances, replace per-SKA lists with shared refs
      — "Save" saves current SKA; "Save All" (Ctrl+Shift+S) saves all dirty SKAs
- [x] 10.3 SKA selector UI: JComboBox in toolbar showing "moduleName (filename)"
      — Switching: collectUIIntoModel() for current, loadModelIntoUI() for new selection
      — Dirty indicator (asterisk) in combo items
      — Visible only when 2+ entries (folder mode), hidden for single-file mode
      — skaSelectorUpdating guard prevents listener re-entry during refresh
- [x] 10.4 Users tab: master pool table + per-SKA membership
      — Single table with "In SKA" checkbox column (when in folder mode)
      — CSV import updates master pool, propagates to all SKAs
      — Add/remove from master pool vs. include/exclude from current SKA
      — loadFromWorkspace()/clearWorkspaceMode() switch table between modes
      — collectUIIntoModel() calls syncEntryUsersFromPool() to persist checked CNs
      — Remove button offers "Remove from Pool" vs "Exclude from SKA" in folder mode
- [x] 10.5 Save All & per-SKA dirty tracking
      — Title bar: "SKA Configurator — folder — currentSka.xml [MODULE] *" (done in 10.2)
      — Exit: check all SKAs for unsaved changes, lists dirty files by name
      — confirmDiscardChanges: lists dirty files in folder mode
      — doSaveAll: syncs ALL entries' user lists from master pool before writing
      — doExit: folder-aware prompt listing N dirty file(s) with bullet list
- [x] 10.6 Tests & build
      — WorkspaceTest: 5 tests covering folder mode, shared users, merge, dirty tracking
        • testFolderModeSharedUsers: 2 XMLs → workspace → modify shared cert → sync+save → re-read verify
        • testEntryLabelsAndDirty: display labels, dirty indicator
        • testWorkspaceEdgeCases: empty workspace, add/remove, clear
        • testActiveIndexSwitching: multi-entry index management on add/remove
        • testMasterPoolMerge: blank-field fill-in, no-overwrite, union by CN
      — All 14 tests pass (9 original + 5 new), clean build, fat JAR OK

---
### Phase 11: Validation Report Generation (2026-02-16)

#### Design decisions
- Report triggered from File menu ("Generate Report…", Ctrl+R) with Yes/No confirmation dialog
- Produces two CSV files (Excel-importable via OpenCSV):
  1. **report_memberships.csv** — flat view of every group membership across all sections/operations/boundaries
  2. **report_users.csv** — user list with parsed X.509 certificate details
- Works in both single-file and folder mode (reports all loaded SKAs)
- User chooses output directory via folder chooser
- EC curve detection: extracted shared `CurveUtils` utility (DRY principle — was duplicated in `EcParametersPanel`)
- EC curve resolution strategy: named > OID-detected from PEM > "Explicit parameters" > "(none)"
- Certificate parsing via JDK's `java.security.cert.X509Certificate` — no extra dependencies

#### Implementation plan
- [x] 11.1 CurveUtils utility class (com.pki.util)
      — Shared KNOWN_CURVES array (single source of truth)
      — OID→curve name map for ASN.1-based detection from raw PEM (brainpool, NIST/SECG curves)
      — detectCurveFromPem(): Base64 decode → hex scan for known OIDs
      — resolveCurveName(): named → detected → "Explicit parameters" → "(none)"
      — EcParametersPanel updated to use CurveUtils.KNOWN_CURVES (removed local duplicate)
- [x] 11.2 CertUtils utility class (com.pki.util)
      — Parses PEM-encoded X.509 certs via CertificateFactory
      — Extracts: Subject, Issuer, Not Before, Not After, Serial Number, Key Usage bits, SHA-256 fingerprint
      — Graceful null/blank/malformed handling (returns null on parse failure)
      — Key usage bit names per RFC 5280
- [x] 11.3 ReportGenerator (com.pki.io)
      — generate(): produces both CSV files in one call, returns ReportResult with file refs + row counts
      — Membership report columns: SKA Module, Section, EC Curve, Key Label, Start/End Validity,
        Blocked On Init, Operation, Delay, Time Limit, Boundary #, Group Name, Quorum, Type (Member/Key), Member/Key value
      — Handles: empty boundaries ("no boundaries" row), empty groups, key-only groups vs member groups
      — Member CN→Name resolution via lookup map from user pool
      — Covers all sections: Organization, SKA Plus, SKA Modify, Keys (with dynamic child name)
      — User report columns: CN, Name, Email, Organisation, Has Certificate, Subject, Issuer,
        Not Before, Not After, Key Usage, Serial Number, SHA-256 Fingerprint
      — Users sorted by CN (case-insensitive) for clean report output
- [x] 11.4 MainFrame integration
      — "Generate Report…" menu item (Ctrl+R) between Import CSV and Exit
      — doGenerateReport(): syncs UI→model before generating, handles single-file and folder mode
      — Folder chooser for output directory (defaults to workspace or current file folder)
      — Success dialog with row counts and output path; error dialog on failure
- [x] 11.5 JFileChooser performance fix (bonus)
      — All 5 JFileChooser instantiations replaced with fastFileChooser() helper
      — Sets FileChooser.useShellFolder=false to bypass Windows shell integration (15s → instant)
- [x] 11.6 Tests
      — CurveUtilsTest (10 tests): curve resolution, PEM detection, null/malformed handling, known curves array
      — ReportGeneratorTest (4 tests): full XML report, user report, empty boundaries, multi-entry report
      — All 38 tests pass (24 previous + 10 CurveUtils + 4 ReportGenerator), clean build
